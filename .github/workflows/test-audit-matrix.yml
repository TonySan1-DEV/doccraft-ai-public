name: Test Audit Provider Detection

on:
  workflow_dispatch:

jobs:
  audit-matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        provider: [aws, gcp, none]
    steps:
      - uses: actions/checkout@v3

      - name: Set Test Environment
        id: set-env
        run: |
          if [ "${{ matrix.provider }}" = "aws" ]; then
            echo "AWS_ACCESS_KEY_ID=fake-aws-key" >> $GITHUB_ENV
            echo "AWS_SECRET_ACCESS_KEY=fake-aws-secret" >> $GITHUB_ENV
            echo "GCP_SERVICE_ACCOUNT=" >> $GITHUB_ENV
          elif [ "${{ matrix.provider }}" = "gcp" ]; then
            echo "AWS_ACCESS_KEY_ID=" >> $GITHUB_ENV
            echo "AWS_SECRET_ACCESS_KEY=" >> $GITHUB_ENV
            echo "GCP_SERVICE_ACCOUNT={\"project_id\":\"fake-gcp\"}" >> $GITHUB_ENV
          else
            echo "AWS_ACCESS_KEY_ID=" >> $GITHUB_ENV
            echo "AWS_SECRET_ACCESS_KEY=" >> $GITHUB_ENV
            echo "GCP_SERVICE_ACCOUNT=" >> $GITHUB_ENV
          fi

      - name: Simulate Provider Detection
        id: detect
        run: |
          if [ -n "${AWS_ACCESS_KEY_ID}" ]; then
            echo "provider=aws" >> $GITHUB_OUTPUT
          elif [ -n "${GCP_SERVICE_ACCOUNT}" ]; then
            echo "provider=gcp" >> $GITHUB_OUTPUT
          else
            echo "provider=none" >> $GITHUB_OUTPUT
          fi

      - name: Log Provider
        run: echo "Detected provider: ${{ steps.detect.outputs.provider }}"

      - name: Run Simulated Audit Job
        if: steps.detect.outputs.provider != 'none'
        run: echo "âœ… Running simulated audit for ${{ steps.detect.outputs.provider }}"

      - name: Skip Audit (No Provider)
        if: steps.detect.outputs.provider == 'none'
        run: echo "ğŸ“ Skipping audit - no provider configured"

      - name: Test Summary
        run: |
          echo "ğŸ§ª Test Matrix Results:"
          echo "Matrix Provider: ${{ matrix.provider }}"
          echo "Detected Provider: ${{ steps.detect.outputs.provider }}"
          if [ "${{ steps.detect.outputs.provider }}" != "none" ]; then
            echo "Status: âœ… Active"
          else
            echo "Status: ğŸ“ Skipped"
          fi 
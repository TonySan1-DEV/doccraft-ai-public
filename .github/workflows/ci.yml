name: CI Orchestrator

on:
  push:
    branches: [ main, next ]
  pull_request:
    branches: [ main, next ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    uses: ./.github/workflows/lint.yml

  typecheck:
    uses: ./.github/workflows/typecheck.yml

  test:
    uses: ./.github/workflows/test.yml

  coverage:
    uses: ./.github/workflows/coverage.yml

  emotionArc:
    uses: ./.github/workflows/emotionArc.yml

  audit-export:
    uses: ./.github/workflows/export-audit-logs.yml
    secrets: inherit

  audit-reingest:
    uses: ./.github/workflows/reingest-audit-logs.yml
    secrets: inherit

  summary:
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, coverage, emotionArc, audit-export, audit-reingest]
    if: always()
    steps:
      - name: Check workflow status
        run: |
          echo "Checking status of all modular workflows..."
          
          # Check if all required jobs succeeded
          if [[ "${{ needs.lint.result }}" == "success" && 
                "${{ needs.typecheck.result }}" == "success" && 
                "${{ needs.test.result }}" == "success" && 
                "${{ needs.coverage.result }}" == "success" && 
                "${{ needs.emotionArc.result }}" == "success" ]]; then
            echo "âœ… All core CI checks passed successfully!"
            echo "âœ… Lint: ${{ needs.lint.result }}"
            echo "âœ… Typecheck: ${{ needs.typecheck.result }}"
            echo "âœ… Test: ${{ needs.test.result }}"
            echo "âœ… Coverage: ${{ needs.coverage.result }}"
            echo "âœ… EmotionArc: ${{ needs.emotionArc.result }}"
            echo "ğŸ“Š Audit Export: ${{ needs.audit-export.result }}"
            echo "ğŸ“Š Audit Reingest: ${{ needs.audit-reingest.result }}"
          else
            echo "âŒ Some CI checks failed:"
            echo "âŒ Lint: ${{ needs.lint.result }}"
            echo "âŒ Typecheck: ${{ needs.typecheck.result }}"
            echo "âŒ Test: ${{ needs.test.result }}"
            echo "âŒ Coverage: ${{ needs.coverage.result }}"
            echo "âŒ EmotionArc: ${{ needs.emotionArc.result }}"
            echo "ğŸ“Š Audit Export: ${{ needs.audit-export.result }}"
            echo "ğŸ“Š Audit Reingest: ${{ needs.audit-reingest.result }}"
            exit 1
          fi

      - name: Comment on PR with summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ needs.lint.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const typecheckStatus = '${{ needs.typecheck.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const testStatus = '${{ needs.test.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const coverageStatus = '${{ needs.coverage.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const emotionArcStatus = '${{ needs.emotionArc.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const auditExportStatus = '${{ needs.audit-export.result }}' === 'success' ? 'âœ…' : 'ğŸ“Š';
            const auditReingestStatus = '${{ needs.audit-reingest.result }}' === 'success' ? 'âœ…' : 'ğŸ“Š';
            
            const overallStatus = '${{ needs.lint.result }}' === 'success' && 
                                '${{ needs.typecheck.result }}' === 'success' && 
                                '${{ needs.test.result }}' === 'success' && 
                                '${{ needs.coverage.result }}' === 'success' && 
                                '${{ needs.emotionArc.result }}' === 'success' ? 'âœ… PASSED' : 'âŒ FAILED';
            
            const comment = `## CI Orchestrator Summary
            
            **Overall Status:** ${overallStatus}
            
            ### Core Checks
            - Lint: ${lintStatus}
            - Type Check: ${typecheckStatus}
            - Tests: ${testStatus}
            - Coverage: ${coverageStatus}
            - Emotion Arc: ${emotionArcStatus}
            
            ### Audit Operations
            - Export Logs: ${auditExportStatus}
            - Reingest Logs: ${auditReingestStatus}
            
            ### Details
            All modular workflows have completed. Individual workflow results are available in the Actions tab.
            
            ---
            *Generated by GitHub Actions*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }); 
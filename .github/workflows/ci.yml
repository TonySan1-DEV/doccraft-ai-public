name: CI Orchestrator

on:
  push:
    branches: [ main, next ]
  pull_request:
    branches: [ main, next ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    uses: ./.github/workflows/lint.yml

  typecheck:
    uses: ./.github/workflows/typecheck.yml

  test:
    uses: ./.github/workflows/test.yml

  coverage:
    uses: ./.github/workflows/coverage.yml

  emotionArc:
    uses: ./.github/workflows/emotionArc.yml

  audit-export:
    uses: ./.github/workflows/export-audit-logs.yml
    secrets: inherit
    with:
      run_audit: ${{ secrets.AWS_ACCESS_KEY_ID != '' || secrets.GCP_SERVICE_ACCOUNT != '' }}
      provider: ${{ secrets.AWS_ACCESS_KEY_ID != '' && 'aws' || secrets.GCP_SERVICE_ACCOUNT != '' && 'gcp' || '' }}

  audit-reingest:
    uses: ./.github/workflows/reingest-audit-logs.yml
    secrets: inherit
    with:
      run_audit: ${{ secrets.AWS_ACCESS_KEY_ID != '' || secrets.GCP_SERVICE_ACCOUNT != '' }}
      provider: ${{ secrets.AWS_ACCESS_KEY_ID != '' && 'aws' || secrets.GCP_SERVICE_ACCOUNT != '' && 'gcp' || '' }}

  summary:
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, coverage, emotionArc, audit-export, audit-reingest]
    if: always()
    steps:
      - name: Check workflow status
        run: |
          echo "Checking status of all modular workflows..."
          
          # Check if all required jobs succeeded
          if [[ "${{ needs.lint.result }}" == "success" && 
                "${{ needs.typecheck.result }}" == "success" && 
                "${{ needs.test.result }}" == "success" && 
                "${{ needs.coverage.result }}" == "success" && 
                "${{ needs.emotionArc.result }}" == "success" ]]; then
            echo "‚úÖ All core CI checks passed successfully!"
            echo "‚úÖ Lint: ${{ needs.lint.result }}"
            echo "‚úÖ Typecheck: ${{ needs.typecheck.result }}"
            echo "‚úÖ Test: ${{ needs.test.result }}"
            echo "‚úÖ Coverage: ${{ needs.coverage.result }}"
            echo "‚úÖ EmotionArc: ${{ needs.emotionArc.result }}"
            echo "üìä Audit Export: ${{ needs.audit-export.result }}"
            echo "üìä Audit Reingest: ${{ needs.audit-reingest.result }}"
          else
            echo "‚ùå Some CI checks failed:"
            echo "‚ùå Lint: ${{ needs.lint.result }}"
            echo "‚ùå Typecheck: ${{ needs.typecheck.result }}"
            echo "‚ùå Test: ${{ needs.test.result }}"
            echo "‚ùå Coverage: ${{ needs.coverage.result }}"
            echo "‚ùå EmotionArc: ${{ needs.emotionArc.result }}"
            echo "üìä Audit Export: ${{ needs.audit-export.result }}"
            echo "üìä Audit Reingest: ${{ needs.audit-reingest.result }}"
            exit 1
          fi

      - name: Comment on PR with summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ needs.lint.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const typecheckStatus = '${{ needs.typecheck.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const testStatus = '${{ needs.test.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const coverageStatus = '${{ needs.coverage.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const emotionArcStatus = '${{ needs.emotionArc.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const auditExportStatus = '${{ needs.audit-export.result }}' === 'success' ? '‚úÖ' : 'üìä';
            const auditReingestStatus = '${{ needs.audit-reingest.result }}' === 'success' ? '‚úÖ' : 'üìä';
            
            const overallStatus = '${{ needs.lint.result }}' === 'success' && 
                                '${{ needs.typecheck.result }}' === 'success' && 
                                '${{ needs.test.result }}' === 'success' && 
                                '${{ needs.coverage.result }}' === 'success' && 
                                '${{ needs.emotionArc.result }}' === 'success' ? '‚úÖ PASSED' : '‚ùå FAILED';
            
            const comment = `## CI Orchestrator Summary
            
            **Overall Status:** ${overallStatus}
            
            ### Core Checks
            - Lint: ${lintStatus}
            - Type Check: ${typecheckStatus}
            - Tests: ${testStatus}
            - Coverage: ${coverageStatus}
            - Emotion Arc: ${emotionArcStatus}
            
            ### Audit Operations
            - Export Logs: ${auditExportStatus}
            - Reingest Logs: ${auditReingestStatus}
            
            ### Details
            All modular workflows have completed. Individual workflow results are available in the Actions tab.
            
            ---
            *Generated by GitHub Actions*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }); 